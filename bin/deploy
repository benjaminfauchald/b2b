#!/bin/bash

# Quick deploy script - merges develop to master and deploys
# Usage: bin/deploy [patch|minor|major] "Release message"

set -e

BUMP_TYPE=${1:-patch}
MESSAGE=${2:-"Deploy to production"}

# Get current version
LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")

# Calculate new version
case $BUMP_TYPE in
    major|minor|patch)
        NEW_VERSION=$(echo $LATEST_TAG | awk -F. -v bump="$BUMP_TYPE" '
            /^v[0-9]+\.[0-9]+\.[0-9]+$/ {
                major=substr($1,2); minor=$2; patch=$3
                if (bump == "major") { major++; minor=0; patch=0 }
                else if (bump == "minor") { minor++; patch=0 }
                else { patch++ }
                print "v" major "." minor "." patch
            }
        ')
        ;;
    *)
        echo "Usage: bin/deploy [patch|minor|major] \"Release message\""
        exit 1
        ;;
esac

echo "ðŸš€ Deploying $NEW_VERSION to production..."

# Ensure we're on develop
git checkout develop
git pull origin develop

# Merge to master
git checkout master
git pull origin master
git merge develop --no-edit

# Tag and push
git tag -a "$NEW_VERSION" -m "$MESSAGE"
git push origin master
git push origin "$NEW_VERSION"

# Back to develop
git checkout develop

echo "âœ… Deployed $NEW_VERSION successfully!"
echo "ðŸ“Š Monitor at: https://github.com/benjaminfauchald/b2b/actions"