#!/usr/bin/env bash

# Simple Deploy Script with Quality Checks
# Usage: ./bin/simple_deploy [commit_message]
# Note: Use this when you're already on master and have changes to deploy

set -e  # Exit on any error

COMMIT_MESSAGE=${1:-"Deploy changes"}

echo "ğŸš€ Starting simple deployment process..."

# Check if we're on master branch
current_branch=$(git rev-parse --abbrev-ref HEAD)
if [ "$current_branch" != "master" ]; then
    echo "âš ï¸  You're not on master branch. Current branch: $current_branch"
    echo "Switch to master branch first: git checkout master"
    echo "Or use ./bin/deploy for full develop->master deployment"
    exit 1
fi

echo "ğŸ“‹ Running pre-deployment quality checks..."

# 1. Fix RuboCop issues
echo "ğŸ”§ Checking and fixing RuboCop issues..."
if bundle exec rubocop --autocorrect; then
    echo "âœ… RuboCop checks passed"
else
    echo "âŒ RuboCop found unfixable issues. Please fix manually."
    exit 1
fi

# Check if RuboCop made any changes
if ! git diff-index --quiet HEAD --; then
    echo "ğŸ“ RuboCop made automatic fixes, staging changes..."
    git add -A
fi

# 2. Run critical tests (domain CSV import tests specifically)
echo "ğŸ§ª Running critical domain CSV import tests..."
if bundle exec rspec spec/requests/domains_csv_import_spec.rb --fail-fast; then
    echo "âœ… Critical tests passed"
else
    echo "âŒ Critical tests failed. Deployment aborted."
    exit 1
fi

# 3. Run full test suite (with timeout to avoid hanging) - Optional
echo "ğŸ§ª Running full test suite (optional - critical tests already passed)..."
# Use gtimeout on macOS, timeout on Linux
if command -v gtimeout >/dev/null 2>&1; then
    TIMEOUT_CMD="gtimeout 300"
elif command -v timeout >/dev/null 2>&1; then
    TIMEOUT_CMD="timeout 300"
else
    TIMEOUT_CMD=""
fi

if [ -n "$TIMEOUT_CMD" ]; then
    if $TIMEOUT_CMD bundle exec rspec --fail-fast; then
        echo "âœ… All tests passed"
    else
        exit_code=$?
        if [ $exit_code -eq 124 ]; then
            echo "âš ï¸  Test suite timed out after 5 minutes, but critical tests passed. Proceeding with deployment."
        else
            echo "âš ï¸  Some tests failed, but critical tests passed. Proceeding with deployment."
        fi
    fi
else
    echo "âš ï¸  No timeout command available. Skipping full test suite (critical tests already passed)."
fi

# 4. Commit any remaining changes and deploy
if ! git diff-index --quiet HEAD --; then
    echo "ğŸ“ Committing changes..."
    git add -A
    git commit -m "$COMMIT_MESSAGE"
fi

echo "ğŸš€ Deploying to remote repository..."
if git push origin master; then
    echo "âœ… Successfully deployed to master branch"
else
    echo "âŒ Deployment failed"
    exit 1
fi

echo ""
echo "ğŸ‰ Simple deployment completed successfully!"
echo "ğŸ“Š Summary:"
echo "   âœ… RuboCop style checks passed"
echo "   âœ… Critical domain CSV import tests passed"
echo "   âœ… Changes pushed to master branch"
echo ""