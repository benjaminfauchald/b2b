#!/bin/bash

# Quick Release Script (Skips Tests) - For Initial Setup
# Usage: ./bin/release-no-tests "1.0.0" "Release description"

set -e  # Exit on any error

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Check if version and description are provided
if [ $# -ne 2 ]; then
    echo -e "${RED}Usage: ./bin/release-no-tests <version> <description>${NC}"
    echo -e "${YELLOW}Example: ./bin/release-no-tests '1.0.0' 'Initial deployment setup'${NC}"
    exit 1
fi

VERSION="$1"
DESCRIPTION="$2"
RELEASE_BRANCH="release/$VERSION"

echo -e "${BLUE}üöÄ Starting release process for version $VERSION (SKIPPING TESTS)${NC}"
echo -e "${YELLOW}‚ö†Ô∏è  This is for initial setup only - use ./bin/release for normal deployments${NC}"

# 1. Make sure we're on develop and it's clean
echo -e "${YELLOW}üìã Checking git status...${NC}"
if [[ $(git status --porcelain) ]]; then
    echo -e "${RED}‚ùå Working directory is not clean. Please commit or stash changes.${NC}"
    exit 1
fi

# Switch to develop and pull latest
echo -e "${YELLOW}üîÑ Switching to develop branch...${NC}"
git checkout develop
git pull origin develop

# 2. Create release branch
echo -e "${YELLOW}üåø Creating release branch: $RELEASE_BRANCH${NC}"
git checkout -b "$RELEASE_BRANCH"

# 3. Update version if VERSION file exists
if [ -f "VERSION" ]; then
    echo "$VERSION" > VERSION
    git add VERSION
    git commit -m "Bump version to $VERSION"
fi

# 4. Merge release to main
echo -e "${YELLOW}üîÄ Merging to main branch...${NC}"
git checkout main
git pull origin main
git merge --no-ff "$RELEASE_BRANCH" -m "Release $VERSION: $DESCRIPTION"

# 5. Create tag
echo -e "${YELLOW}üè∑Ô∏è  Creating tag v$VERSION...${NC}"
git tag -a "v$VERSION" -m "Release $VERSION: $DESCRIPTION"

# 6. Push main and tags (this triggers deployment)
echo -e "${YELLOW}üì§ Pushing to GitHub (this will trigger deployment)...${NC}"
git push origin main
git push origin "v$VERSION"

# 7. Merge back to develop
echo -e "${YELLOW}üîÑ Merging back to develop...${NC}"
git checkout develop
git merge --no-ff "$RELEASE_BRANCH" -m "Merge release $VERSION back to develop"
git push origin develop

# 8. Clean up release branch
echo -e "${YELLOW}üßπ Cleaning up release branch...${NC}"
git branch -d "$RELEASE_BRANCH"

# 9. Show summary
echo -e "${GREEN}üéâ Release $VERSION completed successfully!${NC}"
echo -e "${BLUE}üìä Summary:${NC}"
echo -e "  ‚Ä¢ Version: $VERSION"
echo -e "  ‚Ä¢ Description: $DESCRIPTION"
echo -e "  ‚Ä¢ Branch: main (pushed)"
echo -e "  ‚Ä¢ Tag: v$VERSION (created)"
echo -e "  ‚Ä¢ Deployment: Triggered automatically via GitHub Actions"
echo -e "${YELLOW}üì± Check GitHub Actions for deployment progress:${NC}"
echo -e "  https://github.com/benjaminfauchald/b2b/actions"
echo -e "${GREEN}‚úÖ You can continue working on develop branch!${NC}"
echo -e "${YELLOW}‚ö†Ô∏è  Fix your tests and use ./bin/release for future deployments${NC}"
