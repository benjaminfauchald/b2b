#!/usr/bin/env bash

# Development Quality Check Script
# Run this before committing to catch issues early

set -e

echo "ğŸ” B2B Development Quality Checks"
echo "=================================="

# Check if we're in the right directory
if [ ! -f "Gemfile" ]; then
  echo "âŒ Please run this from the Rails root directory"
  exit 1
fi

# Check if bundle is installed
if ! command -v bundle &> /dev/null; then
  echo "âŒ Bundler not found. Please install bundler first."
  exit 1
fi

echo ""
echo "ğŸ“¦ Checking dependencies..."
bundle check || {
  echo "Installing missing gems..."
  bundle install
}

echo ""
echo "ğŸ¨ Running RuboCop..."
if bundle exec rubocop; then
  echo "âœ… RuboCop passed!"
else
  echo ""
  echo "âŒ RuboCop failed!"
  echo ""
  echo "ğŸ’¡ Auto-fix suggestions:"
  echo "   bundle exec rubocop -a      # Auto-fix safe issues"
  echo "   bundle exec rubocop -A      # Auto-fix all issues (more aggressive)"
  echo ""
  read -p "Would you like to auto-fix safe issues now? (y/N): " -n 1 -r
  echo ""
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "ğŸ”§ Running auto-fix..."
    bundle exec rubocop -a
    echo "âœ… Auto-fix completed! Please review the changes."
  else
    echo "âŒ Please fix RuboCop issues manually"
    exit 1
  fi
fi

echo ""
echo "ğŸ§ª Running tests..."
if bundle exec rspec; then
  echo "âœ… All tests passed!"
else
  echo "âŒ Tests failed! Please fix before committing."
  exit 1
fi

echo ""
echo "ğŸ”’ Checking for secrets..."
if git status --porcelain | grep -E '\.(key|pem|p12|p8|ppk|env)$|credentials\.yml\.enc$'; then
  echo "âš ï¸  Warning: You may be committing sensitive files!"
  echo "Please review the files above carefully."
  echo ""
  read -p "Are you sure you want to continue? (y/N): " -n 1 -r
  echo ""
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "âŒ Commit cancelled for security"
    exit 1
  fi
fi

echo ""
echo "ğŸ‰ All checks passed! Ready to commit."
echo ""
echo "ğŸ’¡ Next steps:"
echo "   git add .                    # Stage your changes"
echo "   git commit -m \"message\"     # Commit with a good message"
echo "   ./bin/release \"1.x.x\" \"description\"  # Deploy to production"