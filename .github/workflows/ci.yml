name: CI

on:
  pull_request:
  push:
    branches: [ master, main, develop ]

env:
  RAILS_ENV: test
  CI: true

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: b2b_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: .ruby-version
          bundler-cache: true

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libpq-dev \
            google-chrome-stable \
            libjemalloc2 \
            libvips \
            libyaml-dev \
            build-essential \
            nodejs

      - name: Setup test database
        env:
          RAILS_ENV: test
          PGHOST: localhost
          PGPORT: 5432
          PGUSER: postgres
          PGPASSWORD: postgres
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/b2b_test
          REDIS_URL: redis://localhost:6379/0
        run: |
          bin/rails db:create
          bin/rails db:schema:load

      - name: Run tests
        env:
          RAILS_ENV: test
          PGHOST: localhost
          PGPORT: 5432
          PGUSER: postgres
          PGPASSWORD: postgres
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/b2b_test
          REDIS_URL: redis://localhost:6379/0
          # Add dummy values for services that tests mock
          PHANTOMBUSTER_API_KEY: test_api_key
          PHANTOMBUSTER_PHANTOM_ID: test_phantom_id
          FIRECRAWL_API_KEY: test_firecrawl_key
          OPENAI_API_KEY: test_openai_key
          GOOGLE_CLIENT_ID: test_google_client_id
          GOOGLE_CLIENT_SECRET: test_google_client_secret
          GITHUB_CLIENT_ID: test_github_client_id
          GITHUB_CLIENT_SECRET: test_github_client_secret
          GOOGLE_SEARCH_API_KEY: test_google_search_key
          GOOGLE_SEARCH_ENGINE_LINKED_IN_COMPANIES_NO_ID: test_engine_id
          GOOGLE_SEARCH_ENGINE_WEB_ID: test_web_engine_id
          # Additional settings for ViewComponent and asset handling
          RAILS_SERVE_STATIC_FILES: true
          DISABLE_SPRING: true
        run: |
          bundle exec rspec --format documentation

      - name: Upload screenshots from failed tests
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: screenshots
          path: tmp/screenshots/
          if-no-files-found: ignore

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage
          path: coverage/
          if-no-files-found: ignore

  lint:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: .ruby-version
          bundler-cache: true

      - name: Run RuboCop
        run: bundle exec rubocop --parallel

  security:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: .ruby-version
          bundler-cache: true

      - name: Run Brakeman
        run: bundle exec brakeman --no-pager