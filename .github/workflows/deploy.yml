name: Deploy to Production

on:
  push:
    branches: [ master ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_PASSWORD: password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: 3.3.0
        bundler-cache: true
    
    - name: Setup test credentials
      run: |
        mkdir -p config/credentials
        echo "2b6511362ac3e7195e7097e15c402eaa" > config/credentials/test.key
    
    - name: Setup test database
      env:
        RAILS_ENV: test
        DATABASE_URL: postgres://postgres:password@localhost:5432/b2b_test
      run: |
        bin/rails db:create
        bin/rails db:migrate
    
    - name: Run tests
      env:
        RAILS_ENV: test
        DATABASE_URL: postgres://postgres:password@localhost:5432/b2b_test
        REDIS_URL: redis://localhost:6379/0
      run: bundle exec rspec
    
    - name: Run linting
      run: bundle exec rubocop

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to production
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          cd /home/benjamin/b2b
          git fetch origin
          git reset --hard origin/master
          
          # Source rbenv environment
          export PATH="$HOME/.rbenv/bin:$PATH"
          eval "$(rbenv init -)"
          
          # Install/update gems
          bundle install --deployment --without development test
          
          # Precompile assets
          RAILS_ENV=production bundle exec rails assets:precompile
          
          # Run database migrations
          RAILS_ENV=production bundle exec rails db:migrate
          
          # Create restart file (used by Passenger/Puma)
          touch tmp/restart.txt
          
          # Restart services using service command (no sudo required)
          service puma restart || systemctl --user restart puma || echo "Puma restart attempted"
          service sidekiq restart || systemctl --user restart sidekiq || echo "Sidekiq restart attempted"
          
          # Health check
          sleep 5
          echo "Checking application health..."
          
          # Check if the application responds
          if curl -f -s http://localhost:4000/version > /dev/null; then
            echo "âœ… Application is responding!"
          else
            echo "âš ï¸  Application may not be fully ready yet"
          fi
          
          echo "ğŸ‰ Deployment completed!"
