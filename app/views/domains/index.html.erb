<% content_for :title, "Domain Testing Dashboard" %>

<div class="w-full">
  <%= render PageHeaderComponent.new(
    title: "Domain Testing Dashboard", 
    subtitle: "Manage and monitor your domain testing operations"
  ) do |component|
    component.with_actions do %>
      <div class="flex space-x-3">
        <%= link_to import_domains_path, 
            class: "px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:ring-4 focus:ring-green-300 font-medium text-sm transition-colors" do %>
          <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
          </svg>
          Import CSV
        <% end %>
        
        <%= link_to new_domain_path, 
            class: "px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 font-medium text-sm transition-colors" do %>
          <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
          </svg>
          Add New Domain
        <% end %>
      </div>
    <% end %>
  <% end %>

  <!-- Testing Controls Section -->
  <div class="mb-8">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <%= render ServiceQueueButtonComponent.new(
        service_name: "domain_testing",
        title: "DNS Testing",
        icon: "🌐",
        action_path: queue_dns_testing_domains_path,
        queue_name: "domain_dns_testing"
      ) %>
      
      <%= render ServiceQueueButtonComponent.new(
        service_name: "domain_mx_testing",
        title: "MX Testing",
        icon: "📧",
        action_path: queue_mx_testing_domains_path,
        queue_name: "domain_mx_testing"
      ) %>
      
      <%= render ServiceQueueButtonComponent.new(
        service_name: "domain_a_record_testing",
        title: "A Record Testing",
        icon: "🔍",
        action_path: queue_a_record_testing_domains_path,
        queue_name: "DomainARecordTestingService"
      ) %>
    </div>
  </div>

  <!-- Statistics Section -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <%= render StatsCardComponent.new(
      label: "DNS Testing Queue",
      value: @queue_stats['domain_dns_testing'] || 0,
      icon: "🌐",
      data_stat: "domain_dns_testing"
    ) %>
    
    <%= render StatsCardComponent.new(
      label: "MX Testing Queue", 
      value: @queue_stats['domain_mx_testing'] || 0,
      icon: "📧",
      data_stat: "domain_mx_testing"
    ) %>
    
    <%= render StatsCardComponent.new(
      label: "A Record Queue",
      value: @queue_stats['DomainARecordTestingService'] || 0,
      icon: "🔍",
      data_stat: "DomainARecordTestingService"
    ) %>
    
    <%= render StatsCardComponent.new(
      label: "Total Processed",
      value: @queue_stats[:total_processed] || 0,
      icon: "✅",
      trend: "+12.5%",
      trend_direction: "up",
      data_stat: "processed"
    ) %>
  </div>

  <!-- Domains Table Section -->
  <%= render CardComponent.new(title: "Domain List") do %>
    <% if @domains.any? %>
      <% 
        headers = ["Domain", "Status", "Last Tested", "DNS Status", "MX Status", "Actions"]
        rows = @domains.map do |domain|
          [
            domain.domain,
            domain.test_status.capitalize,
            domain.updated_at&.strftime("%Y-%m-%d %H:%M") || "Never",
            domain.dns.nil? ? "Not tested" : (domain.dns ? "Active" : "Inactive"),
            domain.mx.nil? ? "Not tested" : (domain.mx ? "Active" : "Inactive"),
            link_to("View", domain_path(domain), class: "text-blue-600 hover:text-blue-800 font-medium")
          ]
        end
      %>
      <%= render TableComponent.new(headers: headers, rows: rows) %>
      
      <!-- Pagination -->
      <div class="mt-4">
        <%= render 'shared/pagy_nav', pagy: @pagy %>
      </div>
    <% else %>
      <div class="text-center py-12">
        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
        </svg>
        <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-white">No domains</h3>
        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Get started by adding your first domain.</p>
        <div class="mt-6">
          <%= link_to new_domain_path,
              class: "inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" do %>
            <svg class="-ml-1 mr-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            Add Domain
          <% end %>
        </div>
      </div>
    <% end %>
  <% end %>
</div>

<script>
// Auto-refresh queue status every 10 seconds
setInterval(function() {
  fetch('<%= queue_status_domains_path %>')
    .then(response => response.json())
    .then(data => {
      // Update queue stats if elements exist
      const dnsQueue = document.querySelector('[data-stat="domain_dns_testing"]');
      const mxQueue = document.querySelector('[data-stat="domain_mx_testing"]');
      const aRecordQueue = document.querySelector('[data-stat="DomainARecordTestingService"]');
      const processed = document.querySelector('[data-stat="processed"]');
      
      if (dnsQueue) dnsQueue.textContent = data.queue_stats.domain_dns_testing || 0;
      if (mxQueue) mxQueue.textContent = data.queue_stats.domain_mx_testing || 0;
      if (aRecordQueue) aRecordQueue.textContent = data.queue_stats.DomainARecordTestingService || 0;
      if (processed) processed.textContent = data.queue_stats.total_processed || 0;
      
      // Also update queue counts in the service buttons
      const dnsQueueInButton = document.querySelector('[data-queue-stat="domain_dns_testing"]');
      const mxQueueInButton = document.querySelector('[data-queue-stat="domain_mx_testing"]');
      const aRecordQueueInButton = document.querySelector('[data-queue-stat="DomainARecordTestingService"]');
      
      if (dnsQueueInButton) dnsQueueInButton.textContent = (data.queue_stats.domain_dns_testing || 0) + ' in queue';
      if (mxQueueInButton) mxQueueInButton.textContent = (data.queue_stats.domain_mx_testing || 0) + ' in queue';
      if (aRecordQueueInButton) aRecordQueueInButton.textContent = (data.queue_stats.DomainARecordTestingService || 0) + ' in queue';
    })
    .catch(error => console.log('Error fetching queue status:', error));
}, 10000);
</script>