<turbo-frame id="<%= service_name %>_stats">
  <% if service_name == "company_web_discovery" && defined?(companies_potential) %>
    <!-- Web Discovery Completion percentage display -->
    <div class="mb-3">
      <%
        # Count companies with revenue > 10M that either:
        # 1. Have been successfully processed by web discovery service, OR
        # 2. Already have a website in the database
        companies_with_websites = Company
          .where("operating_revenue > ?", 10_000_000)
          .where("website IS NOT NULL AND website != ''")
          .count
        
        # Total companies with revenue > 10M
        total_high_revenue = Company.where("operating_revenue > ?", 10_000_000).count
        
        completion_percentage = total_high_revenue > 0 ? (companies_with_websites.to_f / total_high_revenue.to_f) * 100 : 0
        completion_percentage = completion_percentage < 1 ? completion_percentage.round(1) : completion_percentage.round
      %>
      <div class="flex items-center justify-between mb-1">
        <span class="text-sm font-medium text-blue-700 dark:text-white">Web Discovery Completion</span>
        <span class="text-sm font-medium text-blue-700 dark:text-white"><%= completion_percentage %>%</span>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
        <div class="bg-blue-600 h-2.5 rounded-full" style="width: <%= completion_percentage %>%"></div>
      </div>
      <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">
        <%= number_with_delimiter(companies_with_websites) %> of <%= number_with_delimiter(total_high_revenue) %> companies processed
      </p>
    </div>
  <% elsif service_name == "company_financial_data" %>
    <!-- Financial Data Completion percentage display -->
    <div class="mb-3">
      <%
        # Calculate companies that have actually been successfully processed by financial data service
        companies_completed = ServiceAuditLog
          .joins("JOIN companies ON companies.id = CAST(service_audit_logs.record_id AS INTEGER)")
          .where(service_name: "company_financial_data", status: "success")
          .where("companies.source_country = 'NO'")
          .where("companies.source_registry = 'brreg'") 
          .where("companies.ordinary_result IS NULL")
          .where("companies.organization_form_code IN ('AS', 'ASA', 'DA', 'ANS')")
          .count
        
        # Get total potential companies for financial data
        financial_potential = Company.needs_financial_update.count
        
        completion_percentage = financial_potential > 0 ? (companies_completed.to_f / financial_potential.to_f) * 100 : 0
        completion_percentage = completion_percentage < 1 ? completion_percentage.round(1) : completion_percentage.round
      %>
      <div class="flex items-center justify-between mb-1">
        <span class="text-sm font-medium text-blue-700 dark:text-white">Financial Data Completion</span>
        <span class="text-sm font-medium text-blue-700 dark:text-white"><%= completion_percentage %>%</span>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
        <div class="bg-blue-600 h-2.5 rounded-full" style="width: <%= completion_percentage %>%"></div>
      </div>
      <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">
        <%= number_with_delimiter(companies_completed) %> of <%= number_with_delimiter(financial_potential) %> companies processed
      </p>
    </div>
  <% elsif service_name == "company_linkedin_discovery" && defined?(companies_potential) %>
    <!-- LinkedIn Discovery Completion percentage display -->
    <div class="mb-3">
      <%
        # Calculate companies that have actually been successfully processed by LinkedIn discovery service
        companies_completed = ServiceAuditLog
          .joins("JOIN companies ON companies.id = CAST(service_audit_logs.record_id AS INTEGER)")
          .where(service_name: "company_linkedin_discovery", status: "success")
          .where("companies.operating_revenue > ?", 10_000_000)
          .count
        
        completion_percentage = companies_potential > 0 ? (companies_completed.to_f / companies_potential.to_f) * 100 : 0
        completion_percentage = completion_percentage < 1 ? completion_percentage.round(1) : completion_percentage.round
      %>
      <div class="flex items-center justify-between mb-1">
        <span class="text-sm font-medium text-blue-700 dark:text-white">LinkedIn Discovery Completion</span>
        <span class="text-sm font-medium text-blue-700 dark:text-white"><%= completion_percentage %>%</span>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
        <div class="bg-blue-600 h-2.5 rounded-full" style="width: <%= completion_percentage %>%"></div>
      </div>
      <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">
        <%= number_with_delimiter(companies_completed) %> of <%= number_with_delimiter(companies_potential) %> companies processed
      </p>
    </div>
  <% else %>
    <div class="text-sm text-gray-600 dark:text-gray-400">
      <p data-available-count="<%= service_name %>" data-raw-count="<%= companies_needing %>"><%= number_with_delimiter(companies_needing) %> companies need processing</p>
      <p data-queue-stat="<%= service_name %>" data-raw-queue="<%= queue_depth %>"><%= number_with_delimiter(queue_depth) %> in queue</p>
    </div>
  <% end %>
</turbo-frame>